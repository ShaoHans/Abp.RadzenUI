@using Abp.RadzenUI.Application.Contracts.Organizations
@using Abp.RadzenUI.Components.ObjectExtending
@using Microsoft.AspNetCore.Authorization
@using Microsoft.Extensions.Localization
@using Volo.Abp.AspNetCore.Components
@using Volo.Abp.AspNetCore.Components.Web
@using Volo.Abp.Identity
@using Volo.Abp.Identity.Localization
@inject IIdentityUserAppService UserAppService
@inject AbpBlazorMessageLocalizerHelper<IdentityResource> LH
@inherits AbpRadzenUIComponentBase

<RadzenTemplateForm TItem="IdentityUserUpdateDto" Data=@DialogFromOption.Model Submit=@DialogFromOption.OnSubmit Style="max-height:calc(100vh - 200px); display: flex;flex-direction:column">
    <DialogFormLayout CancelText="@L["Cancel"]" CancelClick="@DialogFromOption.OnCancel" SaveText="@L["Save"]">
        <RadzenTabs>
            <Tabs>
                <RadzenTabsItem Text="@IL["DisplayName:UserInfo"]">
                    <RadzenStack Gap="2rem">
                        <RadzenRow AlignItems="AlignItems.Center" RowGap="0.25rem">
                            <RadzenColumn Size="12" SizeMD="4" class="rz-text-align-start rz-text-align-md-end">
                                <RequiredMark />
                                <RadzenLabel Text="@L["DisplayName:UserName"]" Component="UserName" />
                            </RadzenColumn>
                            <RadzenColumn Size="12" SizeMD="8">
                                <RadzenTextBox Name="UserName" @bind-Value=@DialogFromOption.Model.UserName Style="display: block; width: 100%;" MaxLength="IdentityUserConsts.MaxUserNameLength" />
                                <RadzenRequiredValidator Component="UserName" Text="@L.Required("DisplayName:UserName")" />
                            </RadzenColumn>
                        </RadzenRow>
                        <RadzenRow AlignItems="AlignItems.Center" RowGap="0.25rem">
                            <RadzenColumn Size="12" SizeMD="4" class="rz-text-align-start rz-text-align-md-end">
                                <RadzenLabel Text="@L["DisplayName:Password"]" Component="Password" />
                            </RadzenColumn>
                            <RadzenColumn Size="12" SizeMD="8">
                                <RadzenPassword Name="Password" @bind-Value=@DialogFromOption.Model.Password Style="display: block; width: 100%;" MaxLength="IdentityUserConsts.MaxPasswordLength" />
                            </RadzenColumn>
                        </RadzenRow>
                        <RadzenRow AlignItems="AlignItems.Center" RowGap="0.25rem">
                            <RadzenColumn Size="12" SizeMD="4" class="rz-text-align-start rz-text-align-md-end">
                                <RequiredMark />
                                <RadzenLabel Text="@L["DisplayName:Email"]" Component="Email" />
                            </RadzenColumn>
                            <RadzenColumn Size="12" SizeMD="8">
                                <RadzenTextBox Name="Email" @bind-Value=@DialogFromOption.Model.Email Style="display: block; width: 100%;" MaxLength="IdentityUserConsts.MaxEmailLength" />
                                <RadzenRequiredValidator Component="Email" Text="@L.Required("DisplayName:Email")" />
                                <RadzenEmailValidator Component="Email" Text="@L["Volo.Abp.Identity:InvalidEmail", DialogFromOption.Model.Email]" />
                            </RadzenColumn>
                        </RadzenRow>
                        <RadzenRow AlignItems="AlignItems.Center" RowGap="0.25rem">
                            <RadzenColumn Size="12" SizeMD="4" class="rz-text-align-start rz-text-align-md-end">
                                <RadzenLabel Text="@L["DisplayName:PhoneNumber"]" Component="PhoneNumber" />
                            </RadzenColumn>
                            <RadzenColumn Size="12" SizeMD="8">
                                <RadzenTextBox Name="PhoneNumber" @bind-Value=@DialogFromOption.Model.PhoneNumber Style="display: block; width: 100%;" MaxLength="IdentityUserConsts.MaxPhoneNumberLength" />
                            </RadzenColumn>
                        </RadzenRow>
                        <RadzenRow AlignItems="AlignItems.Center" RowGap="0.25rem">
                            <RadzenColumn Size="12" SizeMD="4" class="rz-text-align-start rz-text-align-md-end">
                                <RadzenLabel Text="@L["DisplayName:Name"]" Component="Name" />
                            </RadzenColumn>
                            <RadzenColumn Size="12" SizeMD="8">
                                <RadzenTextBox Name="Name" @bind-Value=@DialogFromOption.Model.Name Style="display: block; width: 100%;" MaxLength="IdentityUserConsts.MaxNameLength" />
                            </RadzenColumn>
                        </RadzenRow>
                        <RadzenRow AlignItems="AlignItems.Center" RowGap="0.25rem">
                            <RadzenColumn Size="12" SizeMD="4" class="rz-text-align-start rz-text-align-md-end">
                                <RadzenLabel Text="@L["DisplayName:Surname"]" Component="Surname" />
                            </RadzenColumn>
                            <RadzenColumn Size="12" SizeMD="8">
                                <RadzenTextBox Name="Surname" @bind-Value=@DialogFromOption.Model.Surname Style="display: block; width: 100%;" MaxLength="IdentityUserConsts.MaxSurnameLength" />
                            </RadzenColumn>
                        </RadzenRow>
                        <RadzenRow AlignItems="AlignItems.Center" RowGap="0.25rem">
                            <RadzenColumn Size="12" SizeMD="4" class="rz-text-align-start rz-text-align-md-end">
                                <RadzenLabel Text="@L["DisplayName:IsActive"]" Component="IsActive" />
                            </RadzenColumn>
                            <RadzenColumn Size="12" SizeMD="8">
                                <RadzenCheckBox TValue="bool" @bind-Value=@DialogFromOption.Model.IsActive Name="IsActive" />
                            </RadzenColumn>
                        </RadzenRow>
                        <RadzenRow AlignItems="AlignItems.Center" RowGap="0.25rem">
                            <RadzenColumn Size="12" SizeMD="4" class="rz-text-align-start rz-text-align-md-end">
                                <RadzenLabel Text="@L["DisplayName:LockoutEnabled"]" Component="LockoutEnabled" />
                            </RadzenColumn>
                            <RadzenColumn Size="12" SizeMD="8">
                                <RadzenCheckBox TValue="bool" @bind-Value=@DialogFromOption.Model.LockoutEnabled Name="LockoutEnabled" />
                            </RadzenColumn>
                        </RadzenRow>
                        <ExtensionProperties TEntityType="IdentityUserUpdateDto" TResourceType="IdentityResource" Entity="@DialogFromOption.Model" LH="@LH" />
                    </RadzenStack>
                </RadzenTabsItem>
                @if (HasManagePermissionsPermission)
                {
                    <RadzenTabsItem Text="@L["Roles"]">
                        <RadzenRow AlignItems="AlignItems.Center" RowGap="0.25rem">
                            <RadzenColumn Size="12" SizeMD="12">
                                <RadzenCheckBoxList Value="@DialogFromOption.Model.RoleNames" TValue="string" Change=@RolesChange Orientation="Orientation.Vertical">
                                    <Items>
                                        @foreach (var role in allRoles)
                                        {
                                            <RadzenCheckBoxListItem Text="@(role.Disabled ? $"{role.Name}(OU)" : role.Name)"
                                                                    Value="@role.Name"
                                                                    Disabled="@role.Disabled" />
                                        }
                                    </Items>
                                </RadzenCheckBoxList>
                            </RadzenColumn>
                        </RadzenRow>
                    </RadzenTabsItem>
                }
            </Tabs>
        </RadzenTabs>
    </DialogFormLayout>
</RadzenTemplateForm>

@code {
    [Parameter] public DialogFromOption<IdentityUserUpdateDto> DialogFromOption { get; set; } = default!;
    [Parameter] public Guid UserId { get; set; }
    [Inject] public IStringLocalizer<AbpRadzenUIResource> IL { get; set; } = default!;
    [Inject] public IOrganizationUnitAppService OuAppService { get; set; } = default!;
    protected bool HasManagePermissionsPermission { get; set; }
    IList<string> roleNames = [];
    IReadOnlyList<string> roleNamesInOu = [];
    IReadOnlyList<RoleItem> allRoles = [];

    public Edit()
    {
        LocalizationResource = typeof(IdentityResource);
    }

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        HasManagePermissionsPermission = await AuthorizationService.IsGrantedAsync(
            IdentityPermissions.Users.ManagePermissions
        );

        roleNames = (await UserAppService.GetAssignableRolesAsync())
            .Items?.Select(r => r.Name).ToArray()
            ?? [];

        roleNamesInOu = (await OuAppService.GetRoleNamesAsync(UserId)).Items ?? [];

        allRoles =
            roleNames
            .Union(roleNamesInOu)              
            .Select(role => new RoleItem(
                role,
                roleNamesInOu.Contains(role)))  
            .OrderBy(r => r.Name)               
            .ToList();
    }

    void RolesChange(IEnumerable<string> values)
    {
        DialogFromOption.Model.RoleNames = values is null ? [] : values.ToArray();
    }

    record RoleItem(string Name, bool Disabled);
}
