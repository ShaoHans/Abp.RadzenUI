@page "/identity/users"
@using Microsoft.AspNetCore.Authorization
@using Volo.Abp.Identity
@using Volo.Abp.Users
@attribute [Authorize(IdentityPermissions.Users.Default)]
@inherits AbpCrudPageBase<IIdentityUserAppService, IdentityUserDto, Guid, GetIdentityUsersInput, IdentityUserCreateDto, IdentityUserUpdateDto>

<PageTitle>@L["Users"]</PageTitle>

@* Freeze Header： Style="height:calc(100vh - 160px)" *@
<RadzenDataGrid @ref="_grid" Data="@_entities" AllowPaging="true" AllowSorting="true"
                PagerHorizontalAlign="HorizontalAlign.Center" Style="height:calc(100vh - 150px)"
                PageSizeOptions="@_pageSizeOptions" ShowPagingSummary="@_showPagerSummary" LoadData="LoadDataAsync"
                Count="@_totalCount" IsLoading="@_isLoading">
    <HeaderTemplate>
        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Start" Wrap="FlexWrap.Wrap">
            @if (HasCreatePermission)
            {
                <RadzenStack Orientation="Orientation.Vertical" Gap="4px">
                    <RadzenButton Icon="add" Text="@L["NewUser"]" Click="@(async () => { await OpenCreateDialogAsync<Create>(L["NewUser"], SetDialogOptions); })" />
                </RadzenStack>
            }
            <RadzenStack Orientation="Orientation.Vertical" style="margin-left: auto;width:20%" Gap="4px">
                <SearchTextBox PlaceHoder="@($"{L["DisplayName:UserName"]}/{L["DisplayName:Email"]}/{L["DisplayName:PhoneNumber"]}")"
                               @bind-Keyword="@GetListInput.Filter" SearchAsync="@_grid.Reload" />
            </RadzenStack>
        </RadzenStack>
    </HeaderTemplate>
    <Columns>
        <RadzenDataGridColumn Property="@nameof(IdentityUserDto.UserName)" Frozen="true" Title="@L["DisplayName:UserName"]" Width="100px" />
        <RadzenDataGridColumn Property="@nameof(IdentityUserDto.UserName)" Title="@IL["Display:User.FullName"]" Width="100px">
            <Template>
                @{
                    var fullName = string.Format(
                    IL["User:FullNameFormat"],
                    context.Name,
                    context.Surname
                    );
                    <RadzenLabel Text="@fullName" />
                }
            </Template>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn Property="@nameof(IdentityUserDto.Email)" Title="@L["DisplayName:Email"]" Width="180px" />
        <RadzenDataGridColumn Property="@nameof(IdentityUserDto.PhoneNumber)" Title="@L["DisplayName:PhoneNumber"]" Width="140px" />
        <RadzenDataGridColumn Title="@L["DisplayName:IsActive"]" Width="60px" Filterable="false" Sortable="false">
            <Template>
                <BooleanIcon Value="@context.IsActive" />
            </Template>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn Title="@L["DisplayName:LockoutEnabled"]" Width="80px" Filterable="false" Sortable="false">
            <Template>
                <BooleanIcon Value="@context.LockoutEnabled" />
            </Template>
        </RadzenDataGridColumn>
        @(RadzenColumnHelper.ExtraPropertiesColumns<IdentityUserDto>(_extraColumns, StringLocalizerFactory))
        <RadzenDataGridColumn Property="@nameof(IdentityUserDto.CreationTime)" Filterable="false" Title="@L["CreationTime"]" Width="130px">
            <Template>
                @context.CreationTime.ToLocalTime().ToString("yyyy-MM-dd HH:mm:ss")
            </Template>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn Title="@L["Actions"]" Width="120px" Frozen="true" Filterable="false" Sortable="false">
            <Template>
                @if ((context.UserName != "admin" || CurrentUser.UserName == "admin") && HasUpdatePermission)
                {
                    <RadzenButton Icon="edit" title="@L["Edit"]" ButtonStyle="ButtonStyle.Success" Size="ButtonSize.Small"
                                  Click="@(async () => await OpenEditDialogAsync<Edit>(@L["Edit"], context, SetDialogOptions, new Dictionary<string, object>{{"UserId",context.Id}}))" />
                }
                @if ((context.UserName != "admin" || CurrentUser.UserName == "admin") && HasManagePermissionsPermission)
                {
                    <RadzenButton Icon="productivity" title="@L["Permissions"]" ButtonStyle="ButtonStyle.Warning" Size="ButtonSize.Small"
                                  Click="@(async () => await OpenAssignPermissionDialog(context))" />
                }
                @if (context.UserName != "admin" && HasDeletePermission)
                {
                    <RadzenButton Icon="delete" title="@L["Delete"]" ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.Small"
                                  Click=@(async () => await OpenDeleteConfirmDialogAsync(context.Id, L["Delete"], L["UserDeletionConfirmationMessage",context.UserName])) />
                }
            </Template>
        </RadzenDataGridColumn>
    </Columns>
</RadzenDataGrid>