@using Volo.Abp.Data
@typeparam TItem

@if (_extraPropertyKeys.Any())
{
    @foreach (var key in _extraPropertyKeys)
    {
        <RadzenDataGridColumn TItem="TItem"
                              Title="@key"
                              Sortable="false"
                              Filterable="false">
            <Template Context="context">
                @if (context is IHasExtraProperties e &&
                        e.ExtraProperties.TryGetValue(key, out var value))
                {
                    if (value is bool b)
                    {
                        <RadzenIcon Icon="@(b ? "check" : "close")"
                                    Style="@(b ? "color:green" : "color:red")" />
                    }
                    else if (value is DateTime dt)
                    {
                        @dt.ToString("yyyy-MM-dd")
                    }
                    else
                    {
                        @value
                    }
                }
                else
                {
                    <span>-</span>
                }
            </Template>
        </RadzenDataGridColumn>
    }
}

@code {

    [CascadingParameter] public RadzenDataGrid<TItem>? Grid { get; set; }

    private IReadOnlyList<string> _extraPropertyKeys = Array.Empty<string>();

    protected override void OnParametersSet()
    {
        ResolveExtraPropertyKeys();
    }

    private void ResolveExtraPropertyKeys()
    {
        if (Grid?.Data is not IEnumerable<TItem> items)
        {
            _extraPropertyKeys = Array.Empty<string>();
            return;
        }

        var first = items.FirstOrDefault();
        if (first is not IHasExtraProperties entity)
        {
            _extraPropertyKeys = Array.Empty<string>();
            return;
        }

        _extraPropertyKeys = entity.ExtraProperties.Keys.ToList();
    }

    private RenderFragment RenderExtraProperty(TItem context, string key) => builder =>
    {
        if (context is not IHasExtraProperties entity)
        {
            builder.AddContent(0, "-");
            return;
        }

        entity.ExtraProperties.TryGetValue(key, out var value);

        if (value is bool b)
        {
            builder.OpenComponent<RadzenIcon>(1);
            builder.AddAttribute(2, "Icon", b ? "check" : "close");
            builder.AddAttribute(3, "Style", b ? "color:green" : "color:red");
            builder.CloseComponent();
            return;
        }

        builder.AddContent(4, value?.ToString());
    };
}
